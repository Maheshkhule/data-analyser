<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Data Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce { animation: bounce 1s infinite; }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- API Key Setup Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-lg w-full mx-4 shadow-2xl">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold mb-2 text-gray-800">üöÄ Welcome to Data Analyzer</h2>
                <p class="text-gray-600">To get started, you need an Anthropic API key</p>
            </div>
            
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
                <p class="text-sm font-bold text-gray-800 mb-3">üìù How to get your FREE API key:</p>
                <ol class="text-sm text-gray-700 space-y-2 list-decimal list-inside">
                    <li>Visit <a href="https://console.anthropic.com" target="_blank" class="text-blue-600 underline font-semibold">console.anthropic.com</a></li>
                    <li>Sign up or log in (it's free!)</li>
                    <li>Click on <strong>"API Keys"</strong> in the menu</li>
                    <li>Click <strong>"Create Key"</strong></li>
                    <li>Copy your key (starts with <code class="bg-gray-200 px-1 rounded">sk-ant-</code>)</li>
                </ol>
                <p class="text-xs text-gray-600 mt-3">üí° You get $5 free credits to start!</p>
            </div>
            
            <div class="mb-4">
                <label class="block mb-2 text-sm font-bold text-gray-700">Enter Your API Key:</label>
                <input 
                    type="password" 
                    id="apiKeyInput" 
                    placeholder="sk-ant-api03-..." 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm font-mono"
                >
            </div>
            
            <button 
                id="saveApiKey" 
                class="w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition font-semibold text-lg shadow-lg"
            >
                ‚ú® Save & Start Analyzing
            </button>
            
            <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                <div class="flex items-start gap-2">
                    <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <div class="text-xs text-green-800">
                        <strong>Your key is safe:</strong> It's stored only in your browser's local storage and never sent anywhere except directly to Anthropic's API.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="flex h-screen bg-gradient-to-br from-purple-50 to-blue-50">
        <!-- Left Panel -->
        <div class="w-96 bg-white shadow-lg border-r border-gray-200 flex flex-col">
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6">
                <div class="flex items-center gap-3 mb-2">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <h1 class="text-2xl font-bold">Data Analyzer</h1>
                </div>
                <p class="text-sm text-purple-100">Upload files and get AI-powered insights</p>
            </div>

            <div class="p-6 flex-1 overflow-y-auto">
                <label class="block">
                    <div class="border-2 border-dashed border-purple-300 rounded-lg p-8 text-center hover:border-purple-500 transition cursor-pointer bg-purple-50 hover:bg-purple-100">
                        <svg class="mx-auto mb-3 text-purple-600 w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="text-sm font-semibold text-gray-700 mb-1">Click to upload files</p>
                        <p class="text-xs text-gray-500">Excel, Word, PDF, or Text files</p>
                        <input type="file" id="fileInput" multiple accept=".xlsx,.xls,.docx,.doc,.pdf,.txt,.csv" class="hidden">
                    </div>
                </label>

                <div id="fileList" class="mt-6 hidden">
                    <h3 class="font-semibold text-gray-700 mb-3">Uploaded Files (<span id="fileCount">0</span>)</h3>
                    <div id="files" class="space-y-2"></div>
                </div>

                <div class="mt-6 space-y-3">
                    <button id="analyzeBtn" disabled class="w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 font-semibold">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                        </svg>
                        Analyze Files
                    </button>
                    
                    <button id="clearBtn" class="w-full py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition hidden">
                        Clear All
                    </button>
                    
                    <button id="changeApiKey" class="w-full py-2 text-sm bg-gray-50 text-gray-600 rounded-lg hover:bg-gray-100 transition border border-gray-200">
                        üîë Change API Key
                    </button>
                </div>

                <div id="statusBox" class="mt-6 p-4 rounded-lg border-2 hidden"></div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="flex-1 flex flex-col">
            <div class="bg-white border-b border-gray-200 px-6 py-4">
                <h2 class="text-xl font-bold text-gray-800">Analysis Results</h2>
                <p class="text-sm text-gray-500">AI-powered insights from your data</p>
            </div>

            <div id="resultsArea" class="flex-1 overflow-y-auto p-6">
                <div id="emptyState" class="text-center text-gray-400 mt-20">
                    <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <p class="text-lg">Upload files and click "Analyze Files" to get started</p>
                </div>

                <div id="loadingState" class="hidden flex items-center justify-center mt-20">
                    <div class="text-center">
                        <div class="inline-flex items-center gap-3 bg-white px-6 py-4 rounded-lg shadow-lg">
                            <div class="flex gap-2">
                                <div class="w-3 h-3 bg-purple-600 rounded-full animate-bounce"></div>
                                <div class="w-3 h-3 bg-blue-600 rounded-full animate-bounce delay-100"></div>
                                <div class="w-3 h-3 bg-purple-600 rounded-full animate-bounce delay-200"></div>
                            </div>
                            <span class="text-gray-700 font-medium">Analyzing your data...</span>
                        </div>
                    </div>
                </div>

                <div id="resultsContent" class="hidden max-w-4xl mx-auto">
                    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6">
                        <div class="flex items-center gap-2 mb-4 text-purple-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                            </svg>
                            <h3 class="font-bold text-lg">AI Analysis</h3>
                        </div>
                        <div id="analysisText" class="prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap"></div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6">
                        <h3 class="font-semibold text-gray-700 mb-3">Ask Follow-up Questions</h3>
                        <div class="flex gap-3 mb-4">
                            <input type="text" id="followUpInput" placeholder="e.g., What are the top 3 trends?" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <button id="askBtn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">Ask</button>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button class="quick-question px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm hover:bg-purple-200" data-question="What are the key trends in this data?">Key Trends</button>
                            <button class="quick-question px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200" data-question="Can you provide a summary in bullet points?">Summary</button>
                            <button class="quick-question px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm hover:bg-green-200" data-question="What recommendations do you have?">Recommendations</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFiles = [];
        let fileContentsCache = [];
        let apiKey = localStorage.getItem('anthropic_api_key') || '';

        const elements = {
            fileInput: document.getElementById('fileInput'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            clearBtn: document.getElementById('clearBtn'),
            fileList: document.getElementById('fileList'),
            files: document.getElementById('files'),
            fileCount: document.getElementById('fileCount'),
            emptyState: document.getElementById('emptyState'),
            loadingState: document.getElementById('loadingState'),
            resultsContent: document.getElementById('resultsContent'),
            analysisText: document.getElementById('analysisText'),
            followUpInput: document.getElementById('followUpInput'),
            askBtn: document.getElementById('askBtn'),
            apiKeyModal: document.getElementById('apiKeyModal'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            saveApiKey: document.getElementById('saveApiKey'),
            changeApiKey: document.getElementById('changeApiKey'),
            statusBox: document.getElementById('statusBox')
        };

        // Check if API key exists
        if (apiKey) {
            elements.apiKeyModal.style.display = 'none';
            showStatus('‚úÖ API key loaded. Ready to analyze!', 'success');
        }

        // Save API Key
        elements.saveApiKey.addEventListener('click', () => {
            const key = elements.apiKeyInput.value.trim();
            if (!key) {
                alert('Please enter an API key');
                return;
            }
            if (!key.startsWith('sk-ant-')) {
                alert('Invalid API key format. It should start with "sk-ant-"');
                return;
            }
            apiKey = key;
            localStorage.setItem('anthropic_api_key', key);
            elements.apiKeyModal.style.display = 'none';
            showStatus('‚úÖ API key saved successfully!', 'success');
        });

        // Change API Key
        elements.changeApiKey.addEventListener('click', () => {
            elements.apiKeyModal.style.display = 'flex';
            elements.apiKeyInput.value = '';
        });

        // File Upload
        elements.fileInput.addEventListener('change', (e) => {
            const newFiles = Array.from(e.target.files);
            uploadedFiles = [...uploadedFiles, ...newFiles];
            updateFileList();
        });

        function updateFileList() {
            if (uploadedFiles.length === 0) {
                elements.fileList.classList.add('hidden');
                elements.clearBtn.classList.add('hidden');
                elements.analyzeBtn.disabled = true;
                return;
            }

            elements.fileList.classList.remove('hidden');
            elements.clearBtn.classList.remove('hidden');
            elements.analyzeBtn.disabled = false;
            elements.fileCount.textContent = uploadedFiles.length;
            
            elements.files.innerHTML = uploadedFiles.map((file, idx) => `
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-700 truncate">${file.name}</p>
                        <p class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)} KB</p>
                    </div>
                    <button onclick="removeFile(${idx})" class="text-red-500 hover:text-red-700">‚úï</button>
                </div>
            `).join('');
        }

        window.removeFile = function(idx) {
            uploadedFiles.splice(idx, 1);
            fileContentsCache.splice(idx, 1);
            updateFileList();
        };

        elements.clearBtn.addEventListener('click', () => {
            uploadedFiles = [];
            fileContentsCache = [];
            updateFileList();
            elements.emptyState.classList.remove('hidden');
            elements.resultsContent.classList.add('hidden');
        });

        function showStatus(message, type) {
            const colors = {
                success: 'bg-green-50 border-green-300 text-green-800',
                error: 'bg-red-50 border-red-300 text-red-800',
                info: 'bg-blue-50 border-blue-300 text-blue-800'
            };
            elements.statusBox.className = `mt-6 p-4 rounded-lg border-2 ${colors[type]}`;
            elements.statusBox.textContent = message;
            elements.statusBox.classList.remove('hidden');
        }

        async function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            let content = `Excel File: ${file.name}\n\n`;
                            workbook.SheetNames.forEach(sheetName => {
                                const worksheet = workbook.Sheets[sheetName];
                                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                                content += `Sheet: ${sheetName}\nRows: ${jsonData.length}\nData:\n${JSON.stringify(jsonData.slice(0, 20), null, 2)}\n\n`;
                            });
                            resolve(content);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else if (file.name.endsWith('.docx')) {
                    reader.onload = async (e) => {
                        try {
                            const arrayBuffer = e.target.result;
                            const result = await mammoth.extractRawText({ arrayBuffer });
                            resolve(`Word Document: ${file.name}\n\n${result.value}`);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else if (file.type === 'application/pdf') {
                    reader.onload = (e) => {
                        const base64Data = e.target.result.split(',')[1];
                        resolve({ type: 'pdf', name: file.name, data: base64Data });
                    };
                    reader.readAsDataURL(file);
                } else {
                    reader.onload = (e) => {
                        resolve(`Text File: ${file.name}\n\n${e.target.result}`);
                    };
                    reader.readAsText(file);
                }
                
                reader.onerror = reject;
            });
        }

        elements.analyzeBtn.addEventListener('click', async () => {
            if (uploadedFiles.length === 0) return;
            if (!apiKey) {
                showStatus('‚ùå Please add your API key first', 'error');
                elements.apiKeyModal.style.display = 'flex';
                return;
            }
            
            elements.emptyState.classList.add('hidden');
            elements.loadingState.classList.remove('hidden');
            elements.resultsContent.classList.add('hidden');
            showStatus('üîÑ Reading files...', 'info');
            
            try {
                fileContentsCache = await Promise.all(uploadedFiles.map(file => readFileContent(file)));
                showStatus('ü§ñ Analyzing with AI...', 'info');
                
                const messageContent = [];
                let textPrompt = "Analyze these files and provide comprehensive insights:\n\n";
                
                fileContentsCache.forEach((content, idx) => {
                    if (typeof content === 'object' && content.type === 'pdf') {
                        messageContent.push({
                            type: "document",
                            source: { type: "base64", media_type: "application/pdf", data: content.data }
                        });
                        textPrompt += `File ${idx + 1}: ${content.name} (PDF)\n`;
                    } else {
                        textPrompt += `\nFile ${idx + 1}:\n${content.substring(0, 2000)}\n`;
                    }
                });
                
                textPrompt += `\n\nProvide:\n1. Key findings\n2. Statistical insights\n3. Trends\n4. Recommendations\n5. Notable observations`;
                messageContent.push({ type: "text", text: textPrompt });

                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "x-api-key": apiKey,
                        "anthropic-version": "2023-06-01"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 4000,
                        messages: [{ role: "user", content: messageContent }]
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || `API Error: ${response.status}`);
                }
                
                if (data.content && data.content[0]) {
                    elements.analysisText.textContent = data.content[0].text;
                    elements.loadingState.classList.add('hidden');
                    elements.resultsContent.classList.remove('hidden');
                    showStatus('‚úÖ Analysis complete!', 'success');
                } else {
                    throw new Error('No content in response');
                }
            } catch (error) {
                console.error("Error:", error);
                elements.loadingState.classList.add('hidden');
                elements.emptyState.classList.remove('hidden');
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        });

        async function askQuestion(question) {
            if (!question.trim() || !apiKey) return;
            
            elements.loadingState.classList.remove('hidden');
            elements.resultsContent.classList.add('hidden');
            
            try {
                const messageContent = [];
                let contextPrompt = "Context:\n\n";
                
                fileContentsCache.forEach((content, idx) => {
                    if (typeof content === 'object' && content.type === 'pdf') {
                        messageContent.push({
                            type: "document",
                            source: { type: "base64", media_type: "application/pdf", data: content.data }
                        });
                    } else {
                        contextPrompt += content.substring(0, 1000) + '\n\n';
                    }
                });
                
                contextPrompt += `\nQuestion: ${question}`;
                messageContent.push({ type: "text", text: contextPrompt });

                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "x-api-key": apiKey,
                        "anthropic-version": "2023-06-01"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 2000,
                        messages: [{ role: "user", content: messageContent }]
                    })
                });

                const data = await response.json();
                
                if (data.content && data.content[0]) {
                    elements.analysisText.textContent = data.content[0].text;
                }
                
                elements.loadingState.classList.add('hidden');
                elements.resultsContent.classList.remove('hidden');
            } catch (error) {
                console.error("Error:", error);
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        elements.askBtn.addEventListener('click', () => {
            askQuestion(elements.followUpInput.value);
            elements.followUpInput.value = '';
        });

        elements.followUpInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                askQuestion(elements.followUpInput.value);
                elements.followUpInput.value = '';
            }
        });

        document.querySelectorAll('.quick-question').forEach(btn => {
            btn.addEventListener('click', () => askQuestion(btn.dataset.question));
        });
    </script>
</body>
</html>
